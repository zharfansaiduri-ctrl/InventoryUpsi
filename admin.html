<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Portal - Sistem Permohonan</title>

<link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root{
  --bg1:#1A2350;
  --bg2:#1FA2FF;
  --card:#F4F6F8;
  --accent:#12D8FA;
  --muted:#6B7280;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'League Spartan',sans-serif;}
body{background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;padding:20px;}
.container{max-width:1200px;margin:auto;}
.header{background:var(--card);padding:30px;border-radius:20px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;}
.header h1{color:var(--bg1);font-size:32px;margin-bottom:10px;}
.header .subtitle{color:#4A4A4A;font-size:16px;}
.header button.logout{position:absolute;top:30px;right:30px;background:#f87171;color:#fff;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;}
.tabs{display:flex;gap:10px;margin-bottom:30px;}
.tab{flex:1;padding:15px;background:rgba(255,255,255,0.2);border-radius:12px;color:white;font-size:18px;font-weight:600;cursor:pointer;text-align:center;}
.tab.active{background:var(--card);color:var(--bg1);}
.content-section{display:none;}
.content-section.active{display:block;}
.qr-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;}
.qr-card{background:var(--card);padding:25px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);text-align:center;}
.qr-card h3{color:var(--bg1);}
.qr-code-container{background:#fff;padding:15px;border-radius:12px;margin:15px 0;display:inline-block;}
.download-btn{width:100%;padding:12px;background:linear-gradient(135deg,var(--bg2),var(--accent));color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;}
.table-container{overflow-x:auto;background:var(--card);border-radius:12px;margin-bottom:15px;}
table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:10px;border-bottom:1px solid #ddd;}
th{background:var(--bg1);color:white;}
.loading{text-align:center;color:var(--muted);padding:20px;}
.filter-bar{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;}
.filter-bar select,input{padding:10px;border-radius:8px;}
.status-approved{color:green;font-weight:600;}
.status-rejected{color:red;font-weight:600;}
button.action-btn{padding:5px 10px;margin:2px;border:none;border-radius:6px;color:#fff;cursor:pointer;}
button.approve{background:green;}
button.reject{background:red;}
button.delete{background:#f87171;}
.dashboard{display:flex;gap:20px;margin-bottom:20px;}
.dashboard .card{background:var(--card);padding:20px;border-radius:12px;flex:1;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.2);}
.dashboard .card h2{margin-bottom:10px;color:var(--bg1);}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Admin Portal Sistem Permohonan</h1>
    <p class="subtitle">Dicipta oleh UPSI Holdings Sdn. Bhd.</p>
    <button class="logout" onclick="logout()">Log Keluar</button>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('qr')">Jana QR Code</div>
    <div class="tab" onclick="switchTab('data')">Senarai Permohonan</div>
    <div class="tab" onclick="switchTab('dashboard')">Dashboard</div>
  </div>

  <!-- QR -->
  <div id="qrSection" class="content-section active">
    <div class="qr-grid" id="qrGrid"></div>
  </div>

  <!-- DATA -->
  <div id="dataSection" class="content-section">
    <div class="filter-bar">
      <select id="filterJenis" onchange="applyFilter()">
        <option value="all">Semua Jenis</option>
        <option value="AlatTulis">AlatTulis</option>
        <option value="Kenderaan">Kenderaan</option>
        <option value="Projektor">Projektor</option>
        <option value="KertasA4">KertasA4</option>
      </select>

      <select id="filterBulan" onchange="applyFilter()">
        <option value="all">Semua Bulan</option>
        <option value="01">Januari</option>
        <option value="02">Februari</option>
        <option value="03">Mac</option>
        <option value="04">April</option>
        <option value="05">Mei</option>
        <option value="06">Jun</option>
        <option value="07">Julai</option>
        <option value="08">Ogos</option>
        <option value="09">September</option>
        <option value="10">Oktober</option>
        <option value="11">November</option>
        <option value="12">Disember</option>
      </select>

      <input type="text" id="searchInput" placeholder="Cari nama / jabatan" oninput="applyFilter()">
      <button class="download-btn" onclick="exportExcel()">Export Excel</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Jenis</th>
            <th>Nama</th>
            <th>Jabatan</th>
            <th>Kuantiti</th>
            <th>Tarikh</th>
            <th>Status</th>
            <th>Tindakan</th>
          </tr>
        </thead>
        <tbody id="dataTable">
          <tr><td colspan="8" class="loading">Memuatkan data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardSection" class="content-section">
    <div class="dashboard">
      <div class="card">
        <h2>Total Permohonan</h2>
        <p id="totalCount">0</p>
      </div>
      <div class="card">
        <h2>AlatTulis</h2>
        <p id="alatCount">0</p>
      </div>
      <div class="card">
        <h2>Kenderaan</h2>
        <p id="kenderaanCount">0</p>
      </div>
      <div class="card">
        <h2>Projektor</h2>
        <p id="projektorCount">0</p>
      </div>
      <div class="card">
        <h2>KertasA4</h2>
        <p id="kertasCount">0</p>
      </div>
    </div>
  </div>
</div>

<script>
// ===== SECURITY =====
if(sessionStorage.getItem('isLoggedIn')!=='true'){location.href='adminlogin.html';}
function logout(){sessionStorage.clear();location.href='adminlogin.html';}

// ===== 4 URL QR =====
const SESSION_URLS = [
  { label:"AlatTulis", url:"https://script.google.com/macros/s/AKfycbzn5pexJtysXPybe-i8Z3ZfiHIail-KWCt_J5PbinN8xnxn_AdT1Sx0h7ksJA-gWRcP/exec" },
  { label:"Kenderaan", url:"https://script.google.com/macros/s/AKfycbymqKLWmOd2JnfvByskKW4Qdym-53QLXiYpyPCPpQOQeMoCN_E_duT0hpzyKRkugzUubw/exec" },
  { label:"Projektor", url:"https://script.google.com/macros/s/AKfycby8VsDJS0IjepKP_oiUzCCczHiraGMChzX6cFJ76nXaDM3A-417NkBiYrXHC1Va9IyB/exec" },
  { label:"KertasA4", url:"https://script.google.com/macros/s/AKfycbwuR75-PMmNPjhi8l0xvPl3HGPwcl3097VTmIA_Vu-nC64eP8rcnFfJ6RF01DXKwfHS/exec" }
];

// ===== TAB =====
function switchTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
  if(tab==='qr'){document.querySelectorAll('.tab')[0].classList.add('active');document.getElementById('qrSection').classList.add('active');generateQRCodes();}
  else if(tab==='data'){document.querySelectorAll('.tab')[1].classList.add('active');document.getElementById('dataSection').classList.add('active');loadData();}
  else{document.querySelectorAll('.tab')[2].classList.add('active');document.getElementById('dashboardSection').classList.add('active');updateDashboard();}
}

// ===== QR =====
function generateQRCodes(){
  const grid=document.getElementById('qrGrid');
  grid.innerHTML='';
  SESSION_URLS.forEach((item,i)=>{
    const card=document.createElement('div');
    card.className='qr-card';
    card.innerHTML=`<h3>QR ${item.label}</h3><div class="qr-code-container" id="qr${i}"></div><button class="download-btn" onclick="downloadQR('qr${i}','QR_${item.label}')">Muat Turun QR</button>`;
    grid.appendChild(card);
    new QRCode(document.getElementById(`qr${i}`),{text:item.url,width:200,height:200,colorDark:"#1A2350",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});
  });
}
function downloadQR(id,name){const canvas=document.querySelector(`#${id} canvas`);const a=document.createElement('a');a.href=canvas.toDataURL();a.download=name+'.png';a.click();}

// ===== DATA FULL =====
let allData=[];
let filteredData = [];

async function loadData(){
  allData=[];
  const tbody=document.getElementById('dataTable');
  tbody.innerHTML='<tr><td colspan="8" class="loading">Memuatkan...</td></tr>';
  for(const item of SESSION_URLS){
    try{
      const res=await fetch(item.url);
      const raw=await res.json();
      let rows=[];
      if(Array.isArray(raw)){rows=raw;}
      else if(typeof raw==='object'){Object.values(raw).forEach(v=>{if(Array.isArray(v)) rows=rows.concat(v);});}
      rows.forEach(r=>r.JenisPermohonan=item.label);
      allData=allData.concat(rows);
    }catch(err){console.error('Fetch error:',item.label,err);}
  }
  applyFilter(); // render table + simpan filteredData
}

// ===== RENDER TABLE =====
function renderTable(data){
  const tbody=document.getElementById('dataTable');
  if(!data.length){tbody.innerHTML='<tr><td colspan="8" class="loading">Tiada data</td></tr>';return;}
  tbody.innerHTML=data.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${r.JenisPermohonan}</td>
      <td>${r.Nama||'-'}</td>
      <td>${r.Jabatan||'-'}</td>
      <td>${r.Kuantiti||'-'}</td>
      <td>${r.Timestamp||'-'}</td>
      <td class="${r.Status==='Approved'?'status-approved':r.Status==='Rejected'?'status-rejected':''}">${r.Status||'-'}</td>
      <td>
        <button class="action-btn approve" onclick="changeStatus(${i},'Approved')">Approve</button>
        <button class="action-btn reject" onclick="changeStatus(${i},'Rejected')">Reject</button>
        <button class="action-btn delete" onclick="deleteRow(${i})">Delete</button>
      </td>
    </tr>`).join('');
}

// ===== FILTER + SEARCH + BULAN =====
function applyFilter(){
  const jenis = document.getElementById('filterJenis').value.toLowerCase();
  const bulan = document.getElementById('filterBulan').value;
  const search = document.getElementById('searchInput').value.toLowerCase();

  const filtered = allData.filter(d => {
    const matchJenis = jenis === 'all' || (d.JenisPermohonan || '').toLowerCase() === jenis;
    
    let matchBulan = true;
    if(bulan !== 'all' && d.Timestamp){
      const bulanData = d.Timestamp.split('-')[1];
      matchBulan = bulanData === bulan;
    }

    const matchSearch = (d.Nama || '').toLowerCase().includes(search) ||
                        (d.Jabatan || '').toLowerCase().includes(search);

    return matchJenis && matchBulan && matchSearch;
  });

  renderTable(filtered);
  filteredData = filtered; // simpan untuk export Excel
  updateDashboard();
}

// ===== STATUS CHANGE =====
function changeStatus(index,status){
  allData[index].Status=status;
  applyFilter();
}

function deleteRow(index){
  if(confirm('Anda pasti mahu padam permohonan ini?')){
    allData.splice(index,1);
    applyFilter();
  }
}

// ===== EXPORT EXCEL (filtered data sahaja) =====
function exportExcel(){
  if(!filteredData.length){
    alert('Tiada data untuk dieksport!');
    return;
  }
  const ws = XLSX.utils.json_to_sheet(filteredData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Permohonan');
  XLSX.writeFile(wb, 'Permohonan.xlsx');
}

// ===== DASHBOARD =====
function updateDashboard(){
  document.getElementById('totalCount').innerText=filteredData.length;
  document.getElementById('alatCount').innerText=filteredData.filter(d=>d.JenisPermohonan==='AlatTulis').length;
  document.getElementById('kenderaanCount').innerText=filteredData.filter(d=>d.JenisPermohonan==='Kenderaan').length;
  document.getElementById('projektorCount').innerText=filteredData.filter(d=>d.JenisPermohonan==='Projektor').length;
  document.getElementById('kertasCount').innerText=filteredData.filter(d=>d.JenisPermohonan==='KertasA4').length;
}

document.addEventListener('DOMContentLoaded',generateQRCodes);
</script>

</body>
</html>


