<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<title>Permohonan Aset</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f2f2f2;
  padding:20px;
}
.box {
  max-width:500px;
  margin:auto;
  background:white;
  padding:20px;
  border-radius:10px;
}
input, select, button {
  width:100%;
  padding:10px;
  margin:8px 0;
}
button {
  background:#0d6efd;
  color:white;
  border:none;
  cursor:pointer;
}
button:hover { background:#084298; }
.hidden { display:none; }
</style>
</head>

<body>
<div class="box">
  <h2 id="tajuk">Permohonan Aset</h2>

  <form id="form">
    <input id="nama" placeholder="Nama" required>
    <input id="jabatan" placeholder="Jabatan" required>

    <select id="jenis">
      <option value="">-- Pilih Aset --</option>
      <option value="alat_tulis">Alat Tulis</option>
      <option value="kenderaan">Kenderaan</option>
      <option value="projektor">Projektor</option>
      <option value="kertas_a4">Kertas A4</option>
    </select>

    <input id="item" placeholder="Jenis / Bilangan" class="hidden">
    <input id="tempoh" placeholder="Tempoh" class="hidden">
    <input id="kuantiti" type="number" placeholder="Kuantiti" class="hidden">

    <button type="submit">Hantar</button>
  </form>

  <p id="msg"></p>
</div>

<script>
/* ================== URL API ================== */
const SESSION_API = "https://script.google.com/macros/s/AKfycbxLDT5eCMednWW-2uVkv0g7UpX8anTtflrsQUwY_lGr62MqSx8_b1VZOVLzk8yrxDeDBA/exec";

const RESPONSE_API = {
  alat_tulis: "https://script.google.com/macros/s/AKfycby1zOlFPLSQ-5v66P_Hsy3rqfxgKgaB4Of8j-M7-8jdRV8WS_5mb_W9V0rB5zWdNry2gw/exec",
  kenderaan: "https://script.google.com/macros/s/AKfycbwSj8q7yZhbS9l1KRLZ04FrynpPadjX5ZdxKna6Arm1-3QTTplZMjVTrHWgxV5DvTrmjA/exec",
  projektor: "https://script.google.com/macros/s/AKfycbyjHVje7U-yaWLMaW858rFup9oyzeS2_GH0Htqfk7I61y9wW07mm9odOLl4uHDMWnI/exec",
  kertas_a4: "https://script.google.com/macros/s/AKfycby3A910IAwBskOo6joxToCmrvPSc0lKj7Ea6jS_hDYhJ2twDmzPG8Q26fT423jXAYDa/exec"
};

/* ================== ELEMENT ================== */
const jenis = document.getElementById("jenis");
const item = document.getElementById("item");
const tempoh = document.getElementById("tempoh");
const kuantiti = document.getElementById("kuantiti");
const form = document.getElementById("form");
const msg = document.getElementById("msg");
const nama = document.getElementById("nama");
const jabatan = document.getElementById("jabatan");

let SESSION_TYPE = null;

/* ================== FIELD CONTROL ================== */
function updateField(type) {
  item.classList.add("hidden");
  tempoh.classList.add("hidden");
  kuantiti.classList.add("hidden");
  item.type = "text"; // reset input type default

  if (type === "alat_tulis") {
    item.placeholder = "Jenis Alat";
    item.classList.remove("hidden");
    kuantiti.classList.remove("hidden");
    kuantiti.type = "number";
  }

  if (type === "kenderaan") {
    item.placeholder = "Jenis Kenderaan";
    item.classList.remove("hidden");
    tempoh.classList.remove("hidden");
  }

  if (type === "projektor") {
    item.placeholder = "Bilangan Projektor";
    item.type = "number";
    item.classList.remove("hidden");
    tempoh.classList.remove("hidden");
  }

  if (type === "kertas_a4") {
    kuantiti.classList.remove("hidden");
    kuantiti.type = "number";
  }
}

jenis.addEventListener("change", () => {
  updateField(jenis.value);
});

/* ================== QR SESSION ================== */
const params = new URLSearchParams(window.location.search);
const url = params.get("url");

async function loadSession() {
  if (!url) return;

  try {
    const res = await fetch(`${SESSION_API}?url=${url}`);
    const data = await res.json();

    if (!data || data.status === "not_found") {
      alert("QR tidak sah");
      return;
    }

    document.getElementById("tajuk").innerText = data.butiran;

    const txt = data.butiran.toLowerCase();
    if (txt.includes("alat")) SESSION_TYPE = "alat_tulis";
    else if (txt.includes("kenderaan")) SESSION_TYPE = "kenderaan";
    else if (txt.includes("projektor")) SESSION_TYPE = "projektor";
    else SESSION_TYPE = "kertas_a4";

    jenis.value = SESSION_TYPE;
    jenis.disabled = true;
    updateField(SESSION_TYPE);

  } catch (err) {
    console.error(err);
    alert("Gagal load QR session");
  }
}
loadSession();

/* ================== SUBMIT ================== */
form.addEventListener("submit", async e => {
  e.preventDefault();

  const type = SESSION_TYPE || jenis.value;
  if (!type) {
    msg.innerText = "Sila pilih jenis aset";
    return;
  }

  const today = new Date();
  const dd = String(today.getDate()).padStart(2,'0');
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const yyyy = today.getFullYear();
  const formattedDate = `${dd}/${mm}/${yyyy}`;

  let payload = {
    Nama: nama.value,
    Jabatan: jabatan.value,
    Tarikh: formattedDate
  };

  if (type === "alat_tulis") {
    payload.JenisAlat = item.value;
    payload.Kuantiti = kuantiti.value;
  }

  if (type === "kenderaan") {
    payload.JenisKenderaan = item.value;
    payload.Tempoh = tempoh.value;
  }

  if (type === "projektor") {
    payload.BilanganProjektor = item.value;
    payload.Tempoh = tempoh.value;
  }

  if (type === "kertas_a4") {
    payload.Kuantiti = kuantiti.value;
  }

  try {
    const res = await fetch(RESPONSE_API[type], {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json().catch(()=>({message:"Berjaya direkodkan"}));
    msg.innerText = json.message || "Berjaya direkodkan";
    
    form.reset();
    if (!SESSION_TYPE) updateField("");
    else updateField(SESSION_TYPE);

  } 
  catch (err) {
    console.error(err);
    msg.innerText = "Gagal hantar data";
  }
});
</script>
</body>
</html>
